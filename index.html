<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>I-RUNNING V10.0 PRECISION</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #34C759; --bg: #000000; --card: rgba(25, 25, 25, 0.9); }
        body { background-color: var(--bg); color: white; font-family: -apple-system, system-ui, sans-serif; overflow-x: hidden; }
        
        .glass-card { 
            background: var(--card); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.08); 
            border-radius: 1.5rem; 
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 強化版呼吸燈：大範圍色彩擴散 */
        @keyframes neon-pulse-pro {
            0% { 
                box-shadow: 0 0 10px rgba(52, 199, 89, 0.2), 0 0 20px rgba(52, 199, 89, 0.1);
                border-color: rgba(52, 199, 89, 0.2);
            }
            50% { 
                box-shadow: 0 0 40px rgba(52, 199, 89, 0.6), 0 0 80px rgba(52, 199, 89, 0.3);
                border-color: rgba(52, 199, 89, 0.8);
                transform: scale(1.02);
            }
            100% { 
                box-shadow: 0 0 10px rgba(52, 199, 89, 0.2), 0 0 20px rgba(52, 199, 89, 0.1);
                border-color: rgba(52, 199, 89, 0.2);
            }
        }

        .active-glow { 
            animation: neon-pulse-pro 2.5s infinite ease-in-out; 
            z-index: 10;
        }

        .tab-btn { font-size: 10px; padding: 4px 12px; border-radius: 8px; color: #666; transition: all 0.3s; }
        .tab-btn.active { background: var(--accent); color: black; font-weight: bold; }
        canvas { max-height: 140px !important; }
        
        #mainBtn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="flex flex-col min-h-screen p-6 pb-12">
    <header class="flex justify-between items-start mb-8">
        <div>
            <h1 class="text-2xl font-black tracking-tighter italic">I-RUNNING</h1>
            <span class="text-[9px] bg-emerald-900/30 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/20">V10.0 - AI VOICE ENABLED</span>
        </div>
        <div id="gpsStatus" class="glass-card px-3 py-1 flex items-center gap-2">
            <div id="gpsDot" class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]"></div>
            <span class="text-[9px] font-bold text-gray-500 uppercase">GPS Live</span>
        </div>
    </header>

    <div class="text-center mb-8">
        <div id="timer" class="text-7xl font-light tabular-nums tracking-tighter">00:00</div>
        <p class="text-[10px] text-gray-600 font-bold uppercase tracking-[0.3em] mt-2">Duration</p>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-8">
        <div id="stepCard" class="glass-card p-6 text-center">
            <div id="stepCount" class="text-4xl font-black">0</div>
            <p class="text-[9px] text-gray-400 font-bold uppercase mt-1">Steps</p>
        </div>
        <div id="distCard" class="glass-card p-6 text-center">
            <div id="distCount" class="text-4xl font-black text-[#34C759]">0.00</div>
            <p class="text-[9px] text-gray-400 font-bold uppercase mt-1">Distance (Km)</p>
        </div>
        <div class="glass-card p-5 text-center">
            <div id="speedCount" class="text-3xl font-black text-blue-400">0.0</div>
            <p class="text-[9px] text-gray-400 font-bold uppercase mt-1">Avg Speed</p>
        </div>
        <div class="glass-card p-5 text-center">
            <div id="calCount" class="text-3xl font-black text-orange-500">0</div>
            <p class="text-[9px] text-gray-400 font-bold uppercase mt-1">Calories</p>
        </div>
    </div>

    <div class="flex flex-col items-center mb-10">
        <button id="mainBtn" onclick="toggleRun()" class="w-24 h-24 rounded-full bg-[#34C759] text-black font-black text-lg shadow-2xl active:scale-95">START</button>
        <p class="text-[10px] text-gray-600 mt-4 italic">Voice feedback active</p>
    </div>

    <section class="glass-card p-5 mt-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Performance</h3>
            <div class="flex gap-1 bg-black/50 p-1 rounded-lg">
                <button onclick="updateChart('day')" id="btn-day" class="tab-btn active">DAY</button>
                <button onclick="updateChart('week')" id="btn-week" class="tab-btn">WEEK</button>
            </div>
        </div>
        <canvas id="runChart"></canvas>
    </section>

    <script>
        let running = false, seconds = 0, timerInterval, watchID;
        let totalDist = 0, lastCoords = null, steps = 0, lastAccel = 0, lastStepTime = 0;
        let lastAnnouncedKm = 0;
        let history = JSON.parse(localStorage.getItem('runHistory')) || [];
        let myChart;

        // 語音播報核心函數
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // 停止目前的播報
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'zh-TW';
                msg.rate = 1.1; 
                window.speechSynthesis.speak(msg);
            }
        }

        function toggleRun() {
            const btn = document.getElementById('mainBtn');
            const dot = document.getElementById('gpsDot');
            const cards = [document.getElementById('stepCard'), document.getElementById('distCard')];
            
            if (!running) {
                running = true;
                btn.innerText = 'STOP';
                btn.style.backgroundColor = '#EF4444';
                btn.style.color = 'white';
                dot.style.backgroundColor = '#34C759';
                dot.classList.add('active-glow');
                cards.forEach(c => c.classList.add('active-glow'));
                speak("運動開始，加油");
                startRun();
            } else {
                running = false;
                btn.innerText = 'START';
                btn.style.backgroundColor = '#34C759';
                btn.style.color = 'black';
                dot.style.backgroundColor = '#EF4444';
                dot.classList.remove('active-glow');
                cards.forEach(c => c.classList.remove('active-glow'));
                speak(`運動結束。總距離 ${totalDist.toFixed(2)} 公里，辛苦了`);
                stopRun();
            }
        }

        function startRun() {
            seconds = 0; totalDist = 0; steps = 0; lastAnnouncedKm = 0;
            timerInterval = setInterval(() => {
                seconds++;
                document.getElementById('timer').innerText = new Date(seconds * 1000).toISOString().substr(14, 5);
                
                // 每公里語音提醒
                let currentKm = Math.floor(totalDist);
                if (currentKm > lastAnnouncedKm) {
                    speak(`你已經跑了 ${currentKm} 公里`);
                    lastAnnouncedKm = currentKm;
                }
                
                if(seconds % 2 === 0 && totalDist > 0) {
                    document.getElementById('speedCount').innerText = (totalDist / (seconds/3600)).toFixed(1);
                }
            }, 1000);

            watchID = navigator.geolocation.watchPosition(p => {
                const { latitude, longitude, accuracy } = p.coords;
                if (accuracy > 30) return;
                if (lastCoords) {
                    const d = calculate(lastCoords.latitude, lastCoords.longitude, latitude, longitude);
                    if (d > 0.001) {
                        totalDist += d;
                        document.getElementById('distCount').innerText = totalDist.toFixed(2);
                        document.getElementById('calCount').innerText = Math.floor(totalDist * 62);
                    }
                }
                lastCoords = { latitude, longitude };
            }, null, { enableHighAccuracy: true });
            window.addEventListener('devicemotion', motion);
        }

        function motion(e) {
            let acc = e.accelerationIncludingGravity;
            let current = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            let now = Date.now();
            if (Math.abs(current - lastAccel) > 12 && (now - lastStepTime > 250)) {
                steps++;
                lastStepTime = now;
                document.getElementById('stepCount').innerText = steps;
            }
            lastAccel = current;
        }

        function stopRun() {
            clearInterval(timerInterval);
            navigator.geolocation.clearWatch(watchID);
            window.removeEventListener('devicemotion', motion);
            if (totalDist > 0.01) {
                const today = new Date();
                history.unshift({ date: (today.getMonth()+1)+'/'+today.getDate(), dist: parseFloat(totalDist.toFixed(2)) });
                if(history.length > 7) history.pop();
                localStorage.setItem('runHistory', JSON.stringify(history));
                updateChart('day');
            }
        }

        function calculate(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateChart(mode) {
            const ctx = document.getElementById('runChart').getContext('2d');
            const displayData = [...history].reverse();
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: displayData.map(d => d.date),
                    datasets: [{ data: displayData.map(d => d.dist), backgroundColor: '#34C759', borderRadius: 4 }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#222' } }, x: { grid: { display: false } } }
                }
            });
        }
        window.onload = () => updateChart('day');
    </script>
</body>
</html>
